<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuTranslate</title>
    <link rel="stylesheet" href="/static/pico.css">
    <style>
        body {
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: auto;
            padding: 1rem;
        }

        .log-area {
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            white-space: pre-wrap;
            font-family: monospace;
            margin-top: 1rem;
        }

        .error-message {
            color: #d32f2f; /* Pico invalid color */
        }

        .success-message {
            color: #2e7d32; /* Pico valid color */
        }

        a.no-style {
            text-decoration: none;
            color: inherit;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .button-group {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: right;
            align-items: baseline;
        }

        .spacer {
            flex-grow: 1;
        }

        details {
            margin-bottom: 1rem;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem; /* Added gap for better spacing */
            margin-bottom: 1rem;
        }

        .checkbox-group label { /* Ensure checkboxes are aligned */
            margin-right: 10px;
        }


        #resultArea {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        #downloadButtons {
            display: none;
            margin-top: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            overflow: auto;
        }

        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 8px;
            overflow: auto;
        }

        #previewFrame {
            width: 100%;
            min-height: 500px;
            border: 1px solid #ddd;
        }

        #printFrame {
            display: none;
        }

        #fileDropArea {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }

        #fileDropArea.drag-over {
            border-color: #1095c1;
            background-color: #e7f5fa;
        }

        #fileDropArea.file-selected {
            border-color: #2e7d32;
            background-color: #e8f5e9;
        }

        #fileDropArea p {
            margin: 0.5rem 0;
            color: #555;
        }

        #fileNameDisplay {
            margin-top: 0.5rem;
            font-style: italic;
            color: #333;
        }

        #fileNameDisplay.has-file {
            font-style: normal;
            font-weight: bold;
            color: #1a531d;
        }

        #fileDropArea.input-error, input.input-error, select.input-error { /* Extended to input/select */
            border-color: #d32f2f !important;
        }

        #fileNameDisplay.input-error-text {
            color: #d32f2f !important;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<main class="container">
    <h1>
        <a href="https://github.com/xunbu/docutranslate" target="_blank">DocuTranslateğŸ”—</a>
    </h1>
    <form id="translateForm">

        <div class="form-group">
            <label for="file">æ–‡æ¡£é€‰æ‹©</label>
            <div id="fileDropArea">
                <input type="file" id="file" name="file" required style="display: none;">
                <p id="fileDropPrompt">ç‚¹å‡»æ­¤å¤„é€‰æ‹©æ–‡ä»¶ï¼Œæˆ–å°†æ–‡ä»¶æ‹–æ‹½åˆ°è¿™é‡Œ</p>
                <div id="fileNameDisplay">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="to_lang">ç›®æ ‡è¯­è¨€</label>
                <select id="to_lang" name="to_lang">
                    <option value="ä¸­æ–‡">ä¸­æ–‡ (Chinese)</option>
                    <option value="English">è‹±æ–‡ (English)</option>
                    <option value="æ—¥æœ¬èª">æ—¥è¯­ (Japanese)</option>
                    <option value="í•œêµ­ì–´">éŸ©è¯­ (Korean)</option>
                    <option value="FranÃ§ais">æ³•è¯­ (French)</option>
                    <option value="Deutsch">å¾·è¯­ (German)</option>
                    <option value="EspaÃ±ol">è¥¿ç­ç‰™è¯­ (Spanish)</option>
                    <option value="Italiano">æ„å¤§åˆ©è¯­ (Italian)</option>
                    <option value="PortuguÃªs">è‘¡è„ç‰™è¯­ (Portuguese)</option>
                    <option value="Ğ ÑƒÑÑĞºĞ¸Ğ¹">ä¿„è¯­ (Russian)</option>
                    <option value="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">é˜¿æ‹‰ä¼¯è¯­ (Arabic)</option>
                    <option value="à¤¹à¤¿à¤¨à¥à¤¦à¥€">å°åœ°è¯­ (Hindi)</option>
                    <option value="Nederlands">è·å…°è¯­ (Dutch)</option>
                </select>
            </div>
            <div class="form-group">
                <label>é€‰é¡¹</label>
                <div class="checkbox-group">
                    <label for="formula_ocr"><input type="checkbox" id="formula_ocr" name="formula_ocr" role="switch">å…¬å¼è¯†åˆ«</label>
                    <label for="code_ocr"><input type="checkbox" id="code_ocr" name="code_ocr"
                                                 role="switch">ä»£ç è¯†åˆ«</label>
                    <label for="refine_markdown"><input type="checkbox" id="refine_markdown" name="refine_markdown"
                                                        role="switch">ä¿®æ­£æ–‡æœ¬ï¼ˆè€—æ—¶ï¼‰</label>
                </div>
            </div>
        </div>
        <details>
            <summary>æ–‡æ¡£è½¬æ¢å¼•æ“é…ç½®</summary>
            <div class="form-group">
                <label for="convert_engin">è½¬æ¢å¼•æ“</label>
                <select id="convert_engin" name="convert_engin">
                    <option value="mineru" selected>minerU</option>
                    <option value="docling" id="docling">Docling</option>
                </select>
            </div>
            <div class="form-group hidden" id="mineruTokenGroup">
                <label for="mineru_token">Mineru Token<a class="no-style" href="https://mineru.net/apiManage/token"
                                                         target="_blank"
                                                         title="è·å–ä»¤ç‰Œ">ğŸ”—</a></label>
                <input type="password" id="mineru_token" name="mineru_token" placeholder="ä½¿ç”¨ Mineru å¼•æ“æ—¶å¿…é¡»å¡«å†™">
            </div>
        </details>


        <details>
            <summary>ç¿»è¯‘APIé…ç½®</summary>
            <div class="form-grid">
                <div class="form-group">
                    <label for="platform_select">AI å¹³å° <a id="api_href" class="no-style" href="/"
                                                            target="_blank"
                                                            title="è·å–API-KEY">ğŸ”—</a></label>
                    <select id="platform_select" name="platform_select_ui">
                        <option value="custom">è‡ªå®šä¹‰æ¥å£</option>
                        <option value="https://api.openai.com/v1">OpenAI</option>
                        <option value="https://open.bigmodel.cn/api/paas/v4">æ™ºè°±AI</option>
                        <option value="https://api.deepseek.com/v1">DeepSeek</option>
                        <option value="https://dashscope.aliyuncs.com/compatible-mode/v1">é˜¿é‡Œäº‘ç™¾ç‚¼</option>
                        <option value="https://www.dmxapi.cn/v1">DMXAPI</option>
                        <option value="https://openrouter.ai/api/v1">OpenRouter</option>
                        <option value="https://ark.cn-beijing.volces.com/api/v3">ç«å±±å¼•æ“</option>
                        <option value="https://api.siliconflow.cn/v1">ç¡…åŸºæµåŠ¨</option>
                    </select>
                </div>
                <div class="form-group hidden" id="baseUrlGroup">
                    <label for="base_url">API åœ°å€ (Base URL)</label>
                    <input type="text" id="base_url" name="base_url" placeholder="https://api.openai.com/v1">
                </div>
            </div>
            <div class="form-group">
                <label for="apikey">API å¯†é’¥</label>
                <input type="password" id="apikey" name="apikey" placeholder="å¹³å°å¯¹åº”çš„API Key" required>
            </div>
            <div class="form-group">
                <label for="model_id">æ¨¡å‹ ID</label>
                <input type="text" id="model_id" name="model_id" placeholder="æ¨¡å‹id" required>
            </div>
        </details>
        <button type="submit" id="submitButton" class="primary">å¼€å§‹ç¿»è¯‘</button>
    </form>
    <div id="resultArea">
        <p id="statusMessage"></p>
        <div id="downloadButtons" class="button-group">
            <h4>ç¿»è¯‘ç»“æœ</h4>
            <div class="spacer"></div>
            <a id="downloadMarkdown" href="#" role="button" class="outline">ä¸‹è½½ Markdown</a>
            <a id="downloadHtml" href="#" role="button" class="outline">ä¸‹è½½ HTML</a>
            <button id="downloadPdf" class="outline">ä¸‹è½½ PDF</button>
            <button id="previewHtml" class="outline">é¢„è§ˆ</button>
        </div>
    </div>
    <h4 style="margin-top: 1.5rem;">è¿è¡Œæ—¥å¿—</h4>
    <div class="log-area" id="logArea"></div>
</main>
<div id="previewModal" class="modal">
    <div class="modal-content">
        <span id="closeModalBtn" style="cursor:pointer; float:right; font-size: 1.5rem; line-height: 1;">Ã—</span>
        <h3>HTML é¢„è§ˆ</h3>
        <iframe id="previewFrame"></iframe>
        <div class="button-group">
            <button id="printFromPreview" class="primary">æ‰“å°/ä¿å­˜ä¸ºPDF</button>
            <button id="closePreviewBtn" class="outline">å…³é—­</button>
        </div>
    </div>
</div>
<iframe id="printFrame" style="display:none;"></iframe>
<script>
    const platformSelect = document.getElementById('platform_select');
    const apiHref = document.getElementById('api_href')
    const baseUrlGroup = document.getElementById('baseUrlGroup');
    const baseUrlInput = document.getElementById('base_url');
    const apikeyInput = document.getElementById('apikey');
    const modelInput = document.getElementById('model_id');
    const toLangSelect = document.getElementById('to_lang');
    const formulaCheckbox = document.getElementById('formula_ocr');
    const codeCheckbox = document.getElementById('code_ocr');
    const refineCheckbox = document.getElementById('refine_markdown');

    const convertEnginSelect = document.getElementById('convert_engin');
    const mineruTokenGroup = document.getElementById('mineruTokenGroup');
    const mineruTokenInput = document.getElementById('mineru_token');

    const form = document.getElementById('translateForm');
    const submitButton = document.getElementById('submitButton');
    const logArea = document.getElementById('logArea');
    const statusMsg = document.getElementById('statusMessage');
    const downloadBtns = document.getElementById('downloadButtons');
    const markdownLink = document.getElementById('downloadMarkdown');
    const htmlLink = document.getElementById('downloadHtml');
    const previewHtmlBtn = document.getElementById('previewHtml');
    const downloadPdfBtn = document.getElementById('downloadPdf');
    const printFrameEl = document.getElementById('printFrame');
    const modal = document.getElementById('previewModal');
    const previewFrame = document.getElementById('previewFrame');
    const closeModalButton = document.getElementById('closeModalBtn');
    const closePreviewBtn = document.getElementById('closePreviewBtn');
    const printFromPreview = document.getElementById('printFromPreview');

    const fileInput = document.getElementById('file');
    const fileDropArea = document.getElementById('fileDropArea');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const fileDropPrompt = document.getElementById('fileDropPrompt');

    let logPollIntervalId = null;
    let statusPollIntervalId = null;
    let isTranslating = false;

    function saveToStorage(key, value) {
        try {
            localStorage.setItem(key, value);
        } catch (e) {
            console.warn("ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:", e);
        }
    }

    function getFromStorage(key, defaultValue = '') {
        try {
            return localStorage.getItem(key) || defaultValue;
        } catch (e) {
            console.warn("ä»æœ¬åœ°å­˜å‚¨è¯»å–å¤±è´¥:", e);
            return defaultValue;
        }
    }

    //apiè®¿é—®åœ°å€åˆ°è·å–åœ°å€çš„æ˜ å°„
    const apiHrefMap = {
        "https://openrouter.ai/api/v1": "https://openrouter.ai/settings/keys",
        "https://api.openai.com/v1": "https://platform.openai.com/api-keys",
        "https://api.deepseek.com/v1": "https://platform.deepseek.com/api_keys",
        "https://open.bigmodel.cn/api/paas/v4": "https://open.bigmodel.cn/usercenter/apikeys",
        "https://dashscope.aliyuncs.com/compatible-mode/v1": "https://bailian.console.aliyun.com/?tab=model#/api-key",
        "https://ark.cn-beijing.volces.com/api/v3": "https://console.volcengine.com/ark/region:ark+cn-beijing/apiKey?apikey=%7B%7D",
        "https://api.siliconflow.cn/v1": "https://cloud.siliconflow.cn/account/ak",
        "https://www.dmxapi.cn/v1": "https://www.dmxapi.cn/token"
    }

    function updatePlatformUI() {
        const selectedPlatformValue = platformSelect.value;
        apikeyInput.value = getFromStorage(`translator_platform_${selectedPlatformValue}_apikey`);
        modelInput.value = getFromStorage(`translator_platform_${selectedPlatformValue}_model_id`);
        if (selectedPlatformValue === 'custom') {
            baseUrlGroup.classList.remove('hidden');
            baseUrlInput.required = true;
            baseUrlInput.value = getFromStorage('translator_platform_custom_base_url');
            apiHref.classList.add('hidden')
        } else {
            baseUrlGroup.classList.add('hidden');
            baseUrlInput.required = false;
            baseUrlInput.value = selectedPlatformValue;
            apiHref.classList.remove('hidden')
            apiHref.href = apiHrefMap[baseUrlInput.value]
        }

        saveToStorage('translator_last_platform', selectedPlatformValue);
    }

    function updateConvertEnginUI() {
        const selectedEngin = convertEnginSelect.value;
        if (selectedEngin === 'mineru') {
            mineruTokenGroup.classList.remove('hidden');
            mineruTokenInput.required = true;
            mineruTokenInput.value = getFromStorage('translator_mineru_token');
        } else {
            mineruTokenGroup.classList.add('hidden');
            mineruTokenInput.required = false;
            // Optionally clear if not needed: mineruTokenInput.value = '';
        }
        saveToStorage('translator_convert_engin', selectedEngin);
    }


    function loadSettings() {
        platformSelect.value = getFromStorage('translator_last_platform', 'custom');
        updatePlatformUI();

        convertEnginSelect.value = getFromStorage('translator_convert_engin', 'mineru');

        updateConvertEnginUI(); // Must be after setting convertEnginSelect.value

        toLangSelect.value = getFromStorage('translator_to_lang', 'ä¸­æ–‡');
        formulaCheckbox.checked = getFromStorage('translator_formula_ocr') === 'true';
        codeCheckbox.checked = getFromStorage('translator_code_ocr') === 'true';
        refineCheckbox.checked = getFromStorage('translator_refine_markdown') === 'true';
    }

    loadSettings(); // Initial load

    platformSelect.addEventListener('change', updatePlatformUI);
    apikeyInput.addEventListener('input', (e) => saveToStorage(`translator_platform_${platformSelect.value}_apikey`, e.target.value));
    modelInput.addEventListener('input', (e) => saveToStorage(`translator_platform_${platformSelect.value}_model_id`, e.target.value));
    baseUrlInput.addEventListener('input', (e) => {
        if (platformSelect.value === 'custom') saveToStorage('translator_platform_custom_base_url', e.target.value);
    });

    convertEnginSelect.addEventListener('change', updateConvertEnginUI);
    mineruTokenInput.addEventListener('input', (e) => saveToStorage('translator_mineru_token', e.target.value));

    toLangSelect.addEventListener('change', e => saveToStorage('translator_to_lang', e.target.value));
    formulaCheckbox.addEventListener('change', e => saveToStorage('translator_formula_ocr', e.target.checked.toString()));
    codeCheckbox.addEventListener('change', e => saveToStorage('translator_code_ocr', e.target.checked.toString()));
    refineCheckbox.addEventListener('change', e => saveToStorage('translator_refine_markdown', e.target.checked.toString()));

    [closeModalButton, closePreviewBtn].forEach(elem => elem.addEventListener('click', () => modal.style.display = 'none'));
    window.addEventListener('click', (event) => {
        if (event.target === modal) modal.style.display = 'none';
    });
    printFromPreview.addEventListener('click', () => {
        try {
            previewFrame.contentWindow.focus();
            previewFrame.contentWindow.print();
        } catch (err) {
            console.error('æ‰“å°é¢„è§ˆå†…å®¹å¤±è´¥:', err);
            alert('æ‰“å°å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨æµè§ˆå™¨çš„æ‰“å°åŠŸèƒ½ (Ctrl+P æˆ– âŒ˜+P)ã€‚');
        }
    });

    fileDropArea.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileNameDisplay.textContent = `å·²é€‰æ‹©: ${fileInput.files[0].name}`;
            fileDropArea.classList.add('file-selected');
            fileNameDisplay.classList.add('has-file');
            fileDropPrompt.classList.add('hidden');
            fileDropArea.classList.remove('input-error');
            fileNameDisplay.classList.remove('input-error-text');
            statusMsg.textContent = '';
            statusMsg.className = '';
        } else {
            fileNameDisplay.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            fileDropArea.classList.remove('file-selected');
            fileNameDisplay.classList.remove('has-file');
            fileDropPrompt.classList.remove('hidden');
        }
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, () => {
            if (!fileDropArea.classList.contains('file-selected')) {
                fileDropArea.classList.add('drag-over');
            }
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, () => {
            fileDropArea.classList.remove('drag-over');
        }, false);
    });

    fileDropArea.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            fileInput.files = files;
            const event = new Event('change', {bubbles: true});
            fileInput.dispatchEvent(event);
        }
    }, false);

    //è·å–å¯ä½¿ç”¨çš„engineå¹¶è¿›è¡Œå¤„ç†
    (async () => {
        try {
            const response = await fetch('/get-engin-list')
            if (!response.ok) {
                console.warn(`get engine list failed: ${response.status}`);
                return;
            }
            const enginList = await response.json();
            statusMsg.textContent = 'æ­£åœ¨åˆå§‹åŒ–';
            let options = convertEnginSelect.querySelectors(`option[value="${engin}"]`);
            options.forEach((option) => {
                if (!enginList.includes(option.value)) {
                    option.disabled = true;
                    option.textContent += "(ä¸å¯ç”¨)"
                }
            })
            if (status.includes(convertEnginSelect.value)) {
                convertEnginSelect.value = "mineru";
                updateConvertEnginUI()
                statusMsg.textContent = 'åˆå§‹åŒ–å®Œæˆ';
            }
        } catch (error) {
            console.warn("Error get engin-list", error);
        }
    })()

    async function pollLogs() {
        try {
            const response = await fetch('/get-logs');
            if (!response.ok) {
                console.warn(`Log polling failed: ${response.status}`);
                return;
            }
            const data = await response.json();
            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(log => {
                    const escapedLog = log.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">");
                    logArea.innerHTML += escapedLog + "<br>";
                });
                logArea.scrollTop = logArea.scrollHeight;
            }
        } catch (error) {
            console.warn("Error polling logs:", error);
        }
    }

    async function pollStatus() {
        try {
            const response = await fetch('/get-status');
            if (!response.ok) {
                console.warn(`Status polling failed: ${response.status}`);
                statusMsg.textContent = `çŠ¶æ€æ›´æ–°å¤±è´¥ (${response.status})`;
                statusMsg.className = 'error-message';
                return;
            }
            const status = await response.json();
            statusMsg.textContent = status.status_message || 'æ­£åœ¨è·å–çŠ¶æ€...';
            statusMsg.className = status.error_flag ? 'error-message' : 'success-message';
            if (!status.is_processing) {
                stopPolling();
                submitButton.disabled = false;
                submitButton.removeAttribute('aria-busy');
                submitButton.textContent = 'å¼€å§‹ç¿»è¯‘';
                submitButton.classList.remove('secondary', 'contrast');
                submitButton.classList.add('primary');
                isTranslating = false;

                if (status.download_ready && !status.error_flag) {
                    markdownLink.href = status.markdown_url;
                    markdownLink.setAttribute('download', status.original_filename_stem + '_translated.md');
                    htmlLink.href = status.html_url;
                    htmlLink.setAttribute('download', status.original_filename_stem + '_translated.html');

                    let htmlUrl = status.html_url;
                    let fileName = status.original_filename_stem;

                    previewHtmlBtn.onclick = function () {
                        const currentHtmlUrl = htmlUrl;
                        const currentFileName = fileName;
                        fetch(currentHtmlUrl)
                            .then(resp => {
                                if (!resp.ok) throw new Error(`HTTP error ${resp.status}`);
                                return resp.text();
                            })
                            .then(html => {
                                const blob = new Blob([html], {type: 'text/html'});
                                const blobUrl = URL.createObjectURL(blob);
                                previewFrame.src = blobUrl;
                                previewFrame.onload = function () {
                                    try {
                                        previewFrame.contentWindow.document.title = currentFileName + '_translated';
                                        URL.revokeObjectURL(blobUrl);
                                    } catch (e) {
                                        console.warn('æ— æ³•è®¾ç½®iframeæ ‡é¢˜æˆ–é‡Šæ”¾Blob URL', e);
                                    }
                                };
                                modal.style.display = 'block';
                            })
                            .catch(err => {
                                console.error('é¢„è§ˆ: è·å–HTMLå†…å®¹å¤±è´¥:', err);
                                statusMsg.textContent = 'è·å–HTMLå†…å®¹å¤±è´¥ï¼Œæ— æ³•é¢„è§ˆã€‚';
                                statusMsg.className = 'error-message';
                            });
                    };

                    downloadPdfBtn.onclick = function () {
                        downloadPdfBtn.disabled = true;
                        downloadPdfBtn.textContent = 'å‡†å¤‡PDF...';
                        const currentHtmlUrl = htmlUrl;
                        const currentFileName = fileName;
                        const iframe = printFrameEl;

                        fetch(currentHtmlUrl)
                            .then(resp => {
                                if (!resp.ok) throw new Error(`HTTP error ${resp.status} for PDF HTML`);
                                return resp.text();
                            })
                            .then(htmlContent => {
                                iframe.onload = () => {
                                    iframe.onload = null;
                                    setTimeout(() => {
                                        try {
                                            const iframeWindow = iframe.contentWindow;
                                            if (!iframeWindow) throw new Error("æ— æ³•è®¿é—®æ‰“å°æ¡†æ¶ã€‚");
                                            iframeWindow.document.title = currentFileName + '_translated.pdf';
                                            iframeWindow.focus();
                                            iframeWindow.print();
                                        } catch (err) {
                                            console.error('æ‰“å°PDFå‡ºé”™:', err);
                                            statusMsg.textContent = 'æ— æ³•ç›´æ¥ç”ŸæˆPDFã€‚è¯·é¢„è§ˆHTMLåï¼Œä½¿ç”¨æµè§ˆå™¨çš„æ‰“å°åŠŸèƒ½ (Ctrl+P) ä¿å­˜ã€‚';
                                            statusMsg.className = 'error-message';
                                        } finally {
                                            setTimeout(() => {
                                                downloadPdfBtn.disabled = false;
                                                downloadPdfBtn.textContent = 'ä¸‹è½½ PDF';
                                            }, 2000);
                                        }
                                    }, 500)
                                };
                                iframe.srcdoc = htmlContent;
                            })
                            .catch(err => {
                                console.error('PDFç”Ÿæˆ: è·å–HTMLå†…å®¹å¤±è´¥:', err);
                                statusMsg.textContent = 'è·å–HTMLå†…å®¹å¤±è´¥ï¼Œæ— æ³•ç”ŸæˆPDFã€‚è¯·å°è¯•é¢„è§ˆã€‚';
                                statusMsg.className = 'error-message';
                                downloadPdfBtn.disabled = false;
                                downloadPdfBtn.textContent = 'ä¸‹è½½ PDF';
                            });
                    };
                    downloadBtns.style.display = 'flex';
                } else {
                    downloadBtns.style.display = 'none';
                }
            } else {
                submitButton.textContent = 'å–æ¶ˆç¿»è¯‘';
                submitButton.classList.remove('primary');
                submitButton.classList.add('secondary', 'contrast'); // Using contrast for cancel
                isTranslating = true;
                submitButton.disabled = false;
                submitButton.removeAttribute('aria-busy');
                downloadBtns.style.display = 'none';
            }
        } catch (error) {
            console.error("Error polling status:", error);
            statusMsg.textContent = 'çŠ¶æ€æ›´æ–°å‡ºé”™ã€‚';
            statusMsg.className = 'error-message';
        }
    }

    function startPolling() {
        stopPolling();
        logArea.innerHTML = '';
        pollLogs();
        pollStatus();
        logPollIntervalId = setInterval(pollLogs, 2000);
        statusPollIntervalId = setInterval(pollStatus, 1500);
    }

    function stopPolling() {
        if (logPollIntervalId) clearInterval(logPollIntervalId);
        if (statusPollIntervalId) clearInterval(statusPollIntervalId);
        logPollIntervalId = null;
        statusPollIntervalId = null;
        setTimeout(pollLogs, 500); // One last poll for logs
    }

    async function cancelTranslation() {
        submitButton.disabled = true;
        submitButton.textContent = 'æ­£åœ¨å–æ¶ˆ...';
        submitButton.setAttribute('aria-busy', 'true');

        try {
            const response = await fetch('/cancel-translate', {method: 'POST'});
            const result = await response.json();
            if (response.ok && result.cancelled) {
                statusMsg.textContent = result.message || 'å–æ¶ˆè¯·æ±‚å·²å‘é€ã€‚';
                statusMsg.className = ''; // Clear error class
            } else {
                statusMsg.textContent = result.message || 'å–æ¶ˆå¤±è´¥ã€‚';
                statusMsg.className = 'error-message';
                // Re-enable button if cancellation failed to register server-side
                submitButton.disabled = false;
                submitButton.textContent = 'å–æ¶ˆç¿»è¯‘';
                submitButton.removeAttribute('aria-busy');
            }
        } catch (error) {
            console.error('å–æ¶ˆè¯·æ±‚å¤±è´¥:', error);
            statusMsg.textContent = 'å–æ¶ˆè¯·æ±‚å‘é€å¤±è´¥ã€‚';
            statusMsg.className = 'error-message';
            submitButton.disabled = false;
            submitButton.textContent = 'å–æ¶ˆç¿»è¯‘';
            submitButton.removeAttribute('aria-busy');
        }
        // Status poller will eventually update the button state correctly
    }

    form.addEventListener('submit', async function (event) {
        event.preventDefault();

        if (isTranslating) {
            await cancelTranslation();
            return;
        }

        // Clear previous input errors
        [fileDropArea, mineruTokenInput].forEach(el => el.classList.remove('input-error'));
        fileNameDisplay.classList.remove('input-error-text');

        if (fileInput.files.length === 0) {
            statusMsg.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œç¿»è¯‘ã€‚';
            statusMsg.className = 'error-message';
            fileNameDisplay.textContent = 'è¯·é€‰æ‹©æ–‡ä»¶ï¼';
            fileNameDisplay.classList.add('input-error-text');
            fileDropArea.classList.add('input-error');
            fileDropPrompt.classList.remove('hidden');
            setTimeout(() => {
                fileDropArea.classList.remove('input-error');
                fileNameDisplay.classList.remove('input-error-text');
                if (fileNameDisplay.textContent === 'è¯·é€‰æ‹©æ–‡ä»¶ï¼') fileNameDisplay.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                if (fileInput.files.length === 0) fileDropPrompt.classList.remove('hidden');
            }, 3000);
            return;
        }

        if (convertEnginSelect.value === 'mineru' && !mineruTokenInput.value.trim()) {
            statusMsg.textContent = 'ä½¿ç”¨ Mineru å¼•æ“æ—¶ï¼Œå¿…é¡»å¡«å†™ Mineru Tokenã€‚';
            statusMsg.className = 'error-message';
            mineruTokenInput.classList.add('input-error');
            mineruTokenInput.focus();
            setTimeout(() => mineruTokenInput.classList.remove('input-error'), 3000);
            return;
        }

        stopPolling();
        submitButton.disabled = true;
        submitButton.setAttribute('aria-busy', 'true');
        submitButton.textContent = 'åˆå§‹åŒ–...';
        logArea.innerHTML = '';
        statusMsg.textContent = 'æ­£åœ¨æäº¤ä»»åŠ¡...';
        statusMsg.className = '';
        downloadBtns.style.display = 'none';

        const formData = new FormData(form);
        // FormData automatically includes convert_engin and mineru_token due to 'name' attributes

        try {
            const response = await fetch('/translate', {method: 'POST', body: formData});
            const result = await response.json();
            if (response.ok && result.task_started) {
                statusMsg.textContent = result.message || 'ä»»åŠ¡å·²å¼€å§‹ï¼Œæ­£åœ¨å¤„ç†...';
                statusMsg.className = '';
                submitButton.textContent = 'å–æ¶ˆç¿»è¯‘';
                submitButton.classList.remove('primary');
                submitButton.classList.add('secondary', 'contrast');
                isTranslating = true;
                submitButton.disabled = false; // Enable cancel button
                submitButton.removeAttribute('aria-busy');
                startPolling();
            } else {
                statusMsg.textContent = result.message || `è¯·æ±‚å¤±è´¥ (${response.status})`;
                statusMsg.className = 'error-message';
                submitButton.disabled = false;
                submitButton.removeAttribute('aria-busy');
                submitButton.textContent = 'å¼€å§‹ç¿»è¯‘';
                isTranslating = false;
            }
        } catch (error) {
            console.error('è¯·æ±‚å¤±è´¥:', error);
            statusMsg.textContent = 'è¯·æ±‚ç¿»è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡çŠ¶æ€ã€‚';
            statusMsg.className = 'error-message';
            submitButton.disabled = false;
            submitButton.removeAttribute('aria-busy');
            submitButton.textContent = 'å¼€å§‹ç¿»è¯‘';
            isTranslating = false;
        }
    });
</script>
</body>
</html>