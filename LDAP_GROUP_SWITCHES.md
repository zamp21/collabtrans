# LDAP组查询开关功能说明

## 概述

DocuTranslate现在支持两个LDAP组查询开关，提供灵活的认证策略：

1. **启用管理员组查询** (`ldap_admin_group_enabled`)
2. **启用术语组查询** (`ldap_glossary_group_enabled`)

## 开关组合行为

### 1. 两个开关都关闭（默认状态）
- **管理员组查询**: 关闭
- **用户组查询**: 关闭
- **行为**: 只要LDAP密码认证通过，用户即可作为普通用户登录
- **适用场景**: 简单的LDAP认证，不需要组权限控制

### 2. 只启用管理员组查询
- **管理员组查询**: 开启
- **用户组查询**: 关闭
- **行为**: 
  - 如果用户是管理员组成员 → 获得管理员权限
  - 如果用户不是管理员组成员 → 作为普通用户登录
- **适用场景**: 需要区分管理员和普通用户，但不限制登录用户范围

### 3. 只启用用户组查询
- **管理员组查询**: 关闭
- **用户组查询**: 开启
- **行为**: 
  - 只有用户组成员才能登录
  - 所有登录用户都是普通用户权限
- **适用场景**: 需要限制登录用户范围，但不需要管理员权限

### 4. 两个开关都启用
- **管理员组查询**: 开启
- **用户组查询**: 开启
- **行为**: 
  - 只有用户组成员才能登录
  - 如果用户既是用户组成员又是管理员组成员 → 获得管理员权限
  - 如果用户只是用户组成员 → 作为普通用户登录
- **适用场景**: 完整的组权限控制，既限制登录范围又区分权限等级

## 配置方法

### 通过Web界面配置
1. 管理员登录DocuTranslate
2. 进入"Login Configuration" → "组权限配置"
3. 设置两个开关：
   - ☑️ 启用管理员组查询
   - ☑️ 启用用户组查询
4. 配置组名和搜索路径：
   - 管理员组名: `DocuTranslate-Admins`
   - 普通用户组名: `DocuTranslate-Users`
   - 组搜索Base DN: `OU=Groups,DC=example,DC=com`
5. 保存配置

### 通过环境变量配置
```bash
export LDAP_ADMIN_GROUP_ENABLED=true
export LDAP_GLOSSARY_GROUP_ENABLED=true
export LDAP_ADMIN_GROUP="DocuTranslate-Admins"
export LDAP_GLOSSARY_GROUP="DocuTranslate-Glossary"
export LDAP_GROUP_BASE_DN="OU=Groups,DC=example,DC=com"
```

## 技术实现

### 组查询逻辑
1. **优先使用memberOf属性**: 如果用户的LDAP记录包含`memberOf`属性，直接检查组成员身份
2. **备用组搜索**: 如果`memberOf`属性不可用，通过LDAP搜索来查询组成员身份
3. **容错处理**: 组查询失败时，根据开关设置决定是否允许登录

### 日志记录
系统会详细记录组查询过程，包括：
- 开关状态
- 组查询结果
- 用户角色分配
- 错误信息（如有）

## 安全考虑

1. **默认安全**: 两个开关默认都是关闭状态，确保向后兼容
2. **权限最小化**: 只有在明确启用时才进行组查询
3. **错误处理**: 组查询失败时采用保守策略，避免权限提升
4. **日志审计**: 完整的认证和权限分配日志

## 故障排除

### 常见问题
1. **用户无法登录**: 检查是否启用了用户组查询，用户是否在指定组中
2. **管理员权限不生效**: 检查是否启用了管理员组查询，用户是否在管理员组中
3. **组查询失败**: 检查组搜索Base DN是否正确，LDAP服务器是否可访问

### 调试方法
1. 查看应用日志中的LDAP认证详细信息
2. 使用LDAP工具（如ldapsearch）验证组配置
3. 检查用户的memberOf属性是否包含预期组
