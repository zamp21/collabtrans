<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置 - CollabTrans</title>
    <link rel="icon" href="/static/favicon.ico">
    <link href="/static/bootstrap.css" rel="stylesheet">
    <link href="/static/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/pico.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">CollabTrans</a>
    <div>
      <a class="btn btn-sm btn-outline-light me-2" href="/">首页</a>
      <a class="btn btn-sm btn-primary" href="/settings">设置</a>
    </div>
  </div>
  </nav>

<main class="container py-4">
  <h1 class="h4 mb-3">设置</h1>

  <div class="alert alert-info">此页面用于集中管理系统设置。</div>

  <div class="row g-4">
    <aside class="col-md-3">
      <nav class="list-group sticky-top" style="top: 80px;">
        <a class="list-group-item list-group-item-action" href="#ai-platforms">AI 平台设置</a>
        <a class="list-group-item list-group-item-action" href="#login-settings">登录设置</a>
        <a class="list-group-item list-group-item-action" href="#web-settings">Web 设置（HTTPS）</a>
      </nav>
    </aside>

    <div class="col-md-9">
  <section class="mb-4" id="ai-platforms">
    <h2 class="h5">AI 平台设置</h2>
    <div class="border rounded p-3">
      <div class="mb-3">
        <label class="form-label" for="platformSelect">当前平台</label>
              <select id="platformSelect" class="form-select">
                <!-- 选项将从配置文件动态加载 -->
              </select>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label" for="platformName">平台名称</label>
          <input type="text" class="form-control" id="platformName" placeholder="DeepSeek">
        </div>
        <div class="col-md-6">
          <label class="form-label" for="platformUrl">平台链接</label>
          <input type="url" class="form-control" id="platformUrl" placeholder="https://api.deepseek.com">
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label" for="platformApiKey">API Key</label>
        <div class="input-group">
          <input type="password" class="form-control" id="platformApiKey" placeholder="sk-...">
          <button class="btn btn-outline-secondary toggle-password" type="button" data-target="platformApiKey">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        <div class="form-text">API Key 将安全保存，不会显示明文</div>
      </div>

      <div class="mt-3">
        <label class="form-label" for="modelName">模型名称</label>
        <input type="text" class="form-control" id="modelName" placeholder="deepseek-chat">
        <div class="form-text">如：deepseek-chat, gpt-4, claude-3-sonnet 等</div>
      </div>

      <div class="mt-3">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="maxTokens">最大 Token 数</label>
            <input type="number" class="form-control" id="maxTokens" placeholder="4096" min="1" max="100000">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="temperature">温度参数</label>
            <input type="number" class="form-control" id="temperature" placeholder="0.7" min="0" max="2" step="0.1">
          </div>
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button id="saveAiPlatformBtn" class="btn btn-primary btn-sm">保存 AI 平台设置</button>
        <button id="testAiPlatformBtn" class="btn btn-outline-secondary btn-sm">测试连接</button>
      </div>
    </div>
  </section>

  <section class="mb-4" id="login-settings">
    <h2 class="h5">登录设置</h2>
    <div class="border rounded p-3">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="ldapEnabled">
            <label class="form-check-label" for="ldapEnabled">启用LDAP登录</label>
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="ldapProtocol">协议</label>
          <select id="ldapProtocol" class="form-select">
            <option value="ldap">LDAP</option>
            <option value="ldaps">LDAPS</option>
          </select>
        </div>
      </div>

      <div class="row g-3 mt-0">
        <div class="col-md-6">
          <label for="ldapHost" class="form-label">LDAP服务器（与证书CN/SAN匹配）</label>
          <input type="text" class="form-control" id="ldapHost" placeholder="adtest2.testldaps.io">
        </div>
        <div class="col-md-3">
          <label for="ldapPort" class="form-label">端口</label>
          <input type="number" class="form-control" id="ldapPort" placeholder="389">
        </div>
        <div class="col-md-3">
          <label for="ldapBaseDn" class="form-label">用户搜索 Base DN</label>
          <input type="text" class="form-control" id="ldapBaseDn" placeholder="OU=Users,DC=example,DC=com">
        </div>
      </div>

      <div class="mt-3">
        <label for="ldapBindDnTemplate" class="form-label">绑定 DN 模板</label>
        <input type="text" class="form-control" id="ldapBindDnTemplate" placeholder="EXAMPLE\\{username} 或 {username}@example.com">
      </div>

      <div class="mt-3">
        <label for="ldapUserFilter" class="form-label">用户过滤器</label>
        <input type="text" class="form-control" id="ldapUserFilter" placeholder="(sAMAccountName={username})">
      </div>

      <div class="mt-3">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="ldapAdminGroupEnabled">
              <label class="form-check-label" for="ldapAdminGroupEnabled">启用管理员组查询</label>
            </div>
            <input type="text" class="form-control mt-2" id="ldapAdminGroup" placeholder="DocuTranslate-Admins">
          </div>
          <div class="col-md-6">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="ldapGlossaryGroupEnabled">
              <label class="form-check-label" for="ldapGlossaryGroupEnabled">启用术语表组查询</label>
            </div>
            <input type="text" class="form-control mt-2" id="ldapGlossaryGroup" placeholder="DocuTranslate-Glossary">
          </div>
        </div>
        <div class="mt-3">
          <label for="ldapGroupBaseDn" class="form-label">组搜索 Base DN</label>
          <input type="text" class="form-control" id="ldapGroupBaseDn" placeholder="OU=Groups,DC=example,DC=com">
        </div>
      </div>

      <div id="ldapsConfigContainer" class="mt-3" style="display:none;">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="ldapTlsVerify">
          <label class="form-check-label" for="ldapTlsVerify">验证TLS证书</label>
        </div>
        <div class="mt-2">
          <label for="ldapTlsCacertfile" class="form-label">TLS证书文件路径</label>
          <input type="text" class="form-control" id="ldapTlsCacertfile" placeholder="/path/to/ca.crt">
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <!-- 登录设置保存已合并到页面底部“保存设置”按钮，这里不再单独显示 -->
        <button type="button" class="btn btn-outline-secondary btn-sm" id="genLdapTestCmdBtn">
          生成测试命令
        </button>
        <button type="button" class="btn btn-outline-primary btn-sm" id="runLdapConnectivityBtn">
          测试LDAP连接
        </button>
      </div>

      <!-- LDAP 测试连接弹窗（移植自首页） -->
      <div class="modal fade" id="ldapTestModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">测试 LDAP 连接</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="ldapTestUsernameInput" class="form-label">用户名（不含域）</label>
                <input type="text" class="form-control" id="ldapTestUsernameInput" placeholder="testuser">
              </div>
              <div class="mb-3">
                <label for="ldapTestPasswordInput" class="form-label">密码</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="ldapTestPasswordInput" placeholder="********">
                  <button class="btn btn-outline-secondary toggle-password" type="button" data-target="ldapTestPasswordInput">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="ldapTestConfirmBtn">开始测试</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-4" id="web-settings">
    <h2 class="h5">Web 设置（HTTPS）</h2>
    <div class="border rounded p-3">
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" id="httpsEnabled" disabled>
        <label class="form-check-label" for="httpsEnabled">启用 HTTPS</label>
        <div class="form-text">为安全起见，未通过测试前禁用该开关</div>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label" for="certFile">证书文件（.crt/.pem）</label>
          <input class="form-control" type="file" id="certFile" accept=".crt,.pem">
          <div class="form-text">当前证书：<span id="currentCertName">-</span></div>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="keyFile">私钥文件（.key/.pem）</label>
          <input class="form-control" type="file" id="keyFile" accept=".key,.pem">
          <div class="form-text">当前私钥：<span id="currentKeyName">-</span></div>
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label" for="keyPassword">私钥密码（可选）</label>
        <input class="form-control" type="password" id="keyPassword" placeholder="输入私钥密码">
      </div>

      <div class="mt-3 d-flex gap-2">
        <button id="uploadCertBtn" class="btn btn-outline-secondary btn-sm">上传证书与私钥</button>
        <button id="testHttpsBtn" class="btn btn-outline-success btn-sm">测试证书/HTTPS</button>
      </div>
    </div>
  </section>

  <div class="mt-4">
    <button id="saveAllBtn" class="btn btn-success">保存设置</button>
  </div>
    </div>
  </div>
</main>

<script src="/static/bootstrap.bundle.min.js"></script>
<script>
  async function loadAppConfig() {
    try {
      const resp = await fetch('/auth/app-config');
      if (!resp.ok) return null;
      const cfg = await resp.json();
      // 展示现有证书/私钥文件名
      try {
        const certPath = cfg.https_cert_file || '';
        const keyPath = cfg.https_key_file || '';
        document.getElementById('currentCertName').textContent = certPath ? (certPath.split('/').pop()) : '-';
        document.getElementById('currentKeyName').textContent = keyPath ? (keyPath.split('/').pop()) : '-';
      } catch(_) {}
      return cfg;
    } catch (_) { return null; }
  }

  // AI 平台设置相关 - 从配置文件动态加载
  let platformConfigs = {};
  let platformNames = {};
  let platformUrls = {};
  let platformModels = {};

  // 从配置文件加载平台信息
  async function loadPlatformConfigs() {
    try {
      const resp = await fetch('/auth/app-config');
      if (!resp.ok) return;
      const cfg = await resp.json();
      
      // 读取新的 ai_platforms 结构
      const aiPlatforms = cfg.ai_platforms || {};
      
      // 构建平台配置对象
      platformConfigs = {};
      for (const [key, platform] of Object.entries(aiPlatforms)) {
        platformConfigs[key] = {
          name: platform.name || '',
          url: platform.url || '',
          model: platform.model || '',
          maxTokens: platform.max_tokens || 4096,
          temperature: platform.temperature || 0.7
        };
      }
      
      // 更新平台选择下拉框
      updatePlatformSelect();
    } catch (e) {
      console.error('Load platform configs error:', e);
    }
  }

  // 更新平台选择下拉框
  function updatePlatformSelect() {
    const select = document.getElementById('platformSelect');
    if (!select) return;
    
    // 清空现有选项
    select.innerHTML = '';
    
    // 添加选项
    for (const [key, config] of Object.entries(platformConfigs)) {
      const option = document.createElement('option');
      option.value = key;
      option.textContent = config.name;
      select.appendChild(option);
    }
  }

  // 加载AI平台配置
  async function loadAiPlatformConfig() {
    try {
      const resp = await fetch('/auth/app-config');
      if (!resp.ok) return;
      const cfg = await resp.json();
      
      // 获取当前选中的平台
      const currentPlatform = document.getElementById('platformSelect').value;
      
      // 从新的配置结构中加载数据
      if (cfg.ai_platforms && cfg.ai_platforms[currentPlatform]) {
        const platformConfig = cfg.ai_platforms[currentPlatform];
        
        // 填充表单字段
        document.getElementById('platformName').value = platformConfig.name || '';
        document.getElementById('platformUrl').value = platformConfig.url || '';
        document.getElementById('modelName').value = platformConfig.model || '';
        document.getElementById('maxTokens').value = platformConfig.max_tokens || 4096;
        document.getElementById('temperature').value = platformConfig.temperature || 0.7;
      } else {
        // 如果没有找到配置，使用默认值
        document.getElementById('platformName').value = '';
        document.getElementById('platformUrl').value = '';
        document.getElementById('modelName').value = '';
        document.getElementById('maxTokens').value = 4096;
        document.getElementById('temperature').value = 0.7;
      }
      
      // 单独加载 API Key（从敏感配置）
      await loadApiKey(currentPlatform);
      
    } catch (e) {
      console.error('Load AI platform config error:', e);
    }
  }

  // 加载 API Key
  async function loadApiKey(platform) {
    try {
      const resp = await fetch('/auth/app-config/raw-secrets');
      if (!resp.ok) return;
      const secrets = await resp.json();
      
      const apiKeyInput = document.getElementById('platformApiKey');
      const apiKey = secrets.platform_api_keys?.[platform];
      
      if (apiKey) {
        // 如果 API Key 存在，显示脱敏版本
        const maskedKey = apiKey.substring(0, 8) + '***';
        apiKeyInput.value = maskedKey;
        apiKeyInput.placeholder = '已保存的 API Key';
        // 确保输入框类型为 password，这样脱敏显示才能正常工作
        apiKeyInput.type = 'password';
        
        // 更新眼睛图标状态
        const toggleButton = document.querySelector('[data-target="platformApiKey"]');
        if (toggleButton) {
          const icon = toggleButton.querySelector('i');
          if (icon) {
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
          }
        }
      } else {
        // 如果没有 API Key，清空输入框
        apiKeyInput.value = '';
        apiKeyInput.placeholder = '请输入 API Key';
        apiKeyInput.type = 'password';
      }
    } catch (e) {
      console.error('Load API key error:', e);
      const apiKeyInput = document.getElementById('platformApiKey');
      apiKeyInput.value = '';
      apiKeyInput.placeholder = '请输入 API Key';
      apiKeyInput.type = 'password';
    }
  }

  // 更新平台字段
  function updatePlatformFields() {
    const platform = document.getElementById('platformSelect').value;
    const config = platformConfigs[platform];
    if (!config) return;
    
    document.getElementById('platformName').value = config.name;
    document.getElementById('platformUrl').value = config.url;
    document.getElementById('modelName').value = config.model;
    document.getElementById('maxTokens').value = config.maxTokens;
    document.getElementById('temperature').value = config.temperature;
    
    // 重新加载当前平台的 API Key
    loadApiKey(platform);
  }

  async function saveAppConfig(patch) {
    const resp = await fetch('/auth/app-config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(patch)
    });
    return resp.ok;
  }

  async function uploadCertAndKey(certFile, keyFile) {
    const fd = new FormData();
    if (certFile) fd.append('cert', certFile);
    if (keyFile) fd.append('key', keyFile);
    const resp = await fetch('/auth/web/upload-cert', { method: 'POST', body: fd });
    return resp.ok;
  }

  (async function init(){
    // 设置默认HTTPS禁用，且在未测试前禁用修改
    document.getElementById('httpsEnabled').checked = false;
    document.getElementById('httpsEnabled').disabled = true;

    const cfg = await loadAppConfig();
    if (cfg && typeof cfg.https_enabled !== 'undefined') {
      document.getElementById('httpsEnabled').checked = !!cfg.https_enabled;
    }

    document.getElementById('uploadCertBtn').addEventListener('click', async () => {
      const cert = document.getElementById('certFile').files[0];
      const key = document.getElementById('keyFile').files[0];
      const ok = await uploadCertAndKey(cert, key);
      if (ok) {
        // 重新加载以更新当前文件名显示
        const cfg2 = await loadAppConfig();
        alert('上传成功');
      } else {
        alert('上传失败');
      }
    });

    // 移除单独“保存Web设置”逻辑，合并到“保存设置”按钮

    document.getElementById('testHttpsBtn').addEventListener('click', async () => {
      try {
        // 若输入了密码，先保存以便服务端读取
        const pwd = document.getElementById('keyPassword').value;
        if (pwd) {
          await saveAppConfig({ https_key_password: pwd });
        }
        // 如果用户选择了新文件，先上传，以新证书进行测试
        const certSel = document.getElementById('certFile').files[0];
        const keySel = document.getElementById('keyFile').files[0];
        if (certSel || keySel) {
          const upOk = await uploadCertAndKey(certSel, keySel);
          if (!upOk) {
            alert('上传新证书失败，已取消测试');
            return;
          }
          // 上传后刷新显示
          await loadAppConfig();
        }
        const resp = await fetch('/auth/web/test-https', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await resp.json();
        if (resp.ok && data.ok) {
          alert('HTTPS测试完成\n' + JSON.stringify(data, null, 2));
          // 通过测试后，允许切换启用HTTPS
          document.getElementById('httpsEnabled').disabled = false;
        } else {
          alert('HTTPS测试失败\n' + JSON.stringify(data, null, 2));
          // 测试失败仍保持禁用
          document.getElementById('httpsEnabled').disabled = true;
        }
      } catch (e) {
        alert('HTTPS测试异常: ' + e);
        document.getElementById('httpsEnabled').disabled = true;
      }
    });


    document.getElementById('platformSelect').addEventListener('change', updatePlatformFields);

    async function saveAiPlatformConfig() {
      try {
        const platformType = document.getElementById('platformSelect').value;
        const platformName = document.getElementById('platformName').value;
        const platformUrl = document.getElementById('platformUrl').value;
        const apiKey = document.getElementById('platformApiKey').value;
        const modelName = document.getElementById('modelName').value;
        const maxTokens = parseInt(document.getElementById('maxTokens').value);
        const temperature = parseFloat(document.getElementById('temperature').value);

        // 构建配置结构（不包含 API Key）
        const config = {
          ai_platforms: {
            [platformType]: {
              name: platformName,
              url: platformUrl,
              model: modelName,
              max_tokens: maxTokens,
              temperature: temperature
            }
          }
        };

        // 保存基础配置
        const resp1 = await fetch('/auth/app-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        // 如果有 API Key，单独保存到敏感配置
        if (apiKey && !apiKey.endsWith('***')) {
          const resp2 = await fetch('/auth/app-config/setting', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              key: 'platform_api_keys', 
              value: { [platformType]: apiKey } 
            })
          });
          if (!resp2.ok) {
            alert('API Key 保存失败');
            return false;
          }
        }

        if (resp1.ok) {
          alert('AI 平台设置已保存并立即生效');
          // 重新加载 API Key 显示（脱敏版本）
          await loadApiKey(platformType);
          return true;
        } else {
          const error = await resp1.text();
          alert('保存失败: ' + error);
          return false;
        }
      } catch (e) {
        console.error('Save AI platform config error:', e);
        alert('保存异常: ' + e.message);
        return false;
      }
    }

    async function testAiPlatform() {
      // 立即显示测试进度对话框
      showTestProgressModal();
      
      try {
        const resp = await fetch('/auth/test-ai-platform', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform_type: document.getElementById('platformSelect').value,
            base_url: document.getElementById('platformUrl').value,
            model_name: document.getElementById('modelName').value
          })
        });
        
        // 检查响应状态
        if (!resp.ok) {
          const errorText = await resp.text();
          updateTestProgress('error', '测试失败: HTTP ' + resp.status + ' - ' + errorText);
          return;
        }
        
        // 尝试解析JSON
        let data;
        try {
          data = await resp.json();
        } catch (jsonError) {
          const responseText = await resp.text();
          updateTestProgress('error', '服务器返回无效的JSON响应: ' + responseText);
          return;
        }
        
        if (data.success) {
          updateTestProgress('success', 'AI 平台连接测试成功！');
        } else {
          updateTestProgress('error', 'AI 平台连接测试失败: ' + (data.error || '未知错误'));
        }
      } catch (e) {
        updateTestProgress('error', '测试异常: ' + e.message);
      }
    }

    function showTestProgressModal() {
      // 创建或更新测试进度模态框
      let modal = document.getElementById('testProgressModal');
      if (!modal) {
        modal = createTestProgressModal();
      }
      
      // 重置状态
      updateTestProgress('loading', '正在测试AI平台连接...');
      
      // 显示模态框
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
    }

    function createTestProgressModal() {
      const modalHtml = `
        <div class="modal fade" id="testProgressModal" tabindex="-1" aria-labelledby="testProgressModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="testProgressModalLabel">AI平台连接测试</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div id="testProgressContent">
                  <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-3" role="status" id="testSpinner">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <span id="testProgressText">正在测试AI平台连接...</span>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="testCloseBtn">关闭</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // 将模态框添加到页面
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      return document.getElementById('testProgressModal');
    }

    function updateTestProgress(status, message) {
      const spinner = document.getElementById('testSpinner');
      const text = document.getElementById('testProgressText');
      const closeBtn = document.getElementById('testCloseBtn');
      
      if (!spinner || !text) return;
      
      // 更新文本
      text.textContent = message;
      
      // 根据状态更新UI
      if (status === 'loading') {
        spinner.style.display = 'inline-block';
        spinner.className = 'spinner-border spinner-border-sm text-primary me-3';
        closeBtn.textContent = '关闭';
        closeBtn.className = 'btn btn-secondary';
      } else if (status === 'success') {
        spinner.style.display = 'inline-block';
        spinner.className = 'spinner-border spinner-border-sm text-success me-3';
        // 1秒后隐藏spinner，显示成功图标
        setTimeout(() => {
          spinner.style.display = 'none';
          text.innerHTML = '<i class="bi bi-check-circle-fill text-success me-2"></i>' + message;
        }, 1000);
        closeBtn.textContent = '确定';
        closeBtn.className = 'btn btn-success';
      } else if (status === 'error') {
        spinner.style.display = 'none';
        text.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>' + message;
        closeBtn.textContent = '确定';
        closeBtn.className = 'btn btn-danger';
      }
    }

    document.getElementById('saveAiPlatformBtn').addEventListener('click', saveAiPlatformConfig);
    document.getElementById('testAiPlatformBtn').addEventListener('click', testAiPlatform);

    document.getElementById('saveAllBtn').addEventListener('click', async () => {
      // 1) 先保存LDAP登录设置
      const okLogin = await saveLoginSettings(true);
      // 2) 再保存Web/HTTPS设置
      const patch = {
        https_enabled: document.getElementById('httpsEnabled').checked,
        https_key_password: document.getElementById('keyPassword').value || null
      };
      const okWeb = await saveAppConfig(patch);
      // 3) 保存 AI 平台设置
      const okAi = await saveAiPlatformConfig();
      alert(okLogin && okWeb && okAi ? '所有设置已保存' : '部分设置保存失败');
    });
  })();

  // 迁移登录设置：加载、联动、保存
  async function loadLdapConfig() {
    try {
      const resp = await fetch('/auth/ldap-config');
      if (!resp.ok) return false;
      const cfg = await resp.json();
      document.getElementById('ldapEnabled').checked = !!cfg.ldap_enabled;
      document.getElementById('ldapProtocol').value = cfg.ldap_protocol || 'ldap';
      document.getElementById('ldapHost').value = cfg.ldap_host || '';
      document.getElementById('ldapPort').value = cfg.ldap_port || 389;
      document.getElementById('ldapBindDnTemplate').value = cfg.ldap_bind_dn_template || '';
      document.getElementById('ldapUserFilter').value = cfg.ldap_user_filter || '';
      // 与首页旧结构保持兼容：同时填充用户与组 Base DN
      document.getElementById('ldapBaseDn').value = cfg.ldap_base_dn || '';
      document.getElementById('ldapAdminGroupEnabled').checked = !!cfg.ldap_admin_group_enabled;
      document.getElementById('ldapGlossaryGroupEnabled').checked = !!cfg.ldap_glossary_group_enabled;
      document.getElementById('ldapAdminGroup').value = cfg.ldap_admin_group || '';
      document.getElementById('ldapGlossaryGroup').value = cfg.ldap_glossary_group || '';
      document.getElementById('ldapGroupBaseDn').value = cfg.ldap_group_base_dn || '';
      document.getElementById('ldapTlsVerify').checked = cfg.ldap_tls_verify !== false;
      document.getElementById('ldapTlsCacertfile').value = cfg.ldap_tls_cacertfile || '';

      updateLdapsUi();
      return true;
    } catch (_) { return false; }
  }

  function updateLdapsUi() {
    const isLdaps = document.getElementById('ldapProtocol').value === 'ldaps';
    document.getElementById('ldapsConfigContainer').style.display = isLdaps ? '' : 'none';
  }

  document.getElementById('ldapProtocol').addEventListener('change', updateLdapsUi);

  async function saveLoginSettings(silent=false) {
    const payload = {
      ldap_enabled: document.getElementById('ldapEnabled').checked,
      ldap_protocol: document.getElementById('ldapProtocol').value,
      ldap_host: document.getElementById('ldapHost').value,
      ldap_port: parseInt(document.getElementById('ldapPort').value || '389'),
      ldap_bind_dn_template: document.getElementById('ldapBindDnTemplate').value,
      ldap_base_dn: document.getElementById('ldapBaseDn').value,
      ldap_user_filter: document.getElementById('ldapUserFilter').value,
      ldap_admin_group_enabled: document.getElementById('ldapAdminGroupEnabled').checked,
      ldap_glossary_group_enabled: document.getElementById('ldapGlossaryGroupEnabled').checked,
      ldap_admin_group: document.getElementById('ldapAdminGroup').value,
      ldap_glossary_group: document.getElementById('ldapGlossaryGroup').value,
      ldap_group_base_dn: document.getElementById('ldapGroupBaseDn').value,
      ldap_tls_verify: document.getElementById('ldapTlsVerify').checked,
      ldap_tls_cacertfile: document.getElementById('ldapTlsCacertfile').value
    };
    const resp = await fetch('/auth/ldap-config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!silent) alert(resp.ok ? '登录设置已保存' : '保存失败');
    return resp.ok;
  }


  // 生成 LDAP 测试命令（移植自首页）
  document.getElementById('genLdapTestCmdBtn').addEventListener('click', async () => {
    const protocol = document.getElementById('ldapProtocol').value || 'ldap';
    const host = document.getElementById('ldapHost').value || 'dc.example.com';
    const port = document.getElementById('ldapPort').value || (protocol === 'ldaps' ? '636' : '389');
    const baseDn = document.getElementById('ldapBaseDn').value || 'OU=Users,DC=example,DC=com';
    const tlsVerify = document.getElementById('ldapTlsVerify').checked;
    const cacert = document.getElementById('ldapTlsCacertfile').value;
    const username = prompt('请输入测试用户名（不含域）', 'testuser');
    if (username === null) return;
    const template = document.getElementById('ldapBindDnTemplate').value || '{username}@example.com';
    const bindDnExample = template.replaceAll('{username}', username);
    const baseCmd = `ldapsearch -H ${protocol}://${host}:${port} -D "${bindDnExample}" -W -b "${baseDn}" -x -LLL`;
    const filter = '"(objectClass=*)"';
    const tlsPart = protocol === 'ldaps' ? (tlsVerify ? '' : ' -o tls_reqcert=never') : '';
    const cacertPart = (protocol === 'ldaps' && tlsVerify && cacert) ? ` LDAPTLS_CACERT=${cacert}` : '';
    const finalCmd = `${cacertPart ? cacertPart + ' ' : ''}${baseCmd}${tlsPart} ${filter}`;
    try {
      await navigator.clipboard.writeText(finalCmd);
      alert('命令已复制到剪贴板');
    } catch (err) {
      alert('复制失败，已在控制台输出');
      console.log(finalCmd);
    }
  });

  // 打开弹窗并执行连接测试（移植自首页）
  document.getElementById('runLdapConnectivityBtn').addEventListener('click', async () => {
    const modalEl = document.getElementById('ldapTestModal');
    const modal = new bootstrap.Modal(modalEl);
    document.getElementById('ldapTestUsernameInput').value = '';
    document.getElementById('ldapTestPasswordInput').value = '';
    modal.show();

    const confirmBtn = document.getElementById('ldapTestConfirmBtn');
    const onConfirm = async () => {
      confirmBtn.disabled = true;
      try {
        const username = document.getElementById('ldapTestUsernameInput').value.trim();
        const password = document.getElementById('ldapTestPasswordInput').value;
        if (!username || !password) {
          alert('请填写用户名与密码');
          return;
        }
        const payload = {
          username,
          password,
          ldap_protocol: document.getElementById('ldapProtocol').value,
          ldap_host: document.getElementById('ldapHost').value,
          ldap_port: document.getElementById('ldapPort').value,
          ldap_bind_dn_template: document.getElementById('ldapBindDnTemplate').value,
          ldap_base_dn: document.getElementById('ldapBaseDn').value,
          ldap_user_filter: document.getElementById('ldapUserFilter').value,
          ldap_admin_group_enabled: document.getElementById('ldapAdminGroupEnabled').checked,
          ldap_glossary_group_enabled: document.getElementById('ldapGlossaryGroupEnabled').checked,
          ldap_admin_group: document.getElementById('ldapAdminGroup').value,
          ldap_glossary_group: document.getElementById('ldapGlossaryGroup').value,
          ldap_group_base_dn: document.getElementById('ldapGroupBaseDn').value,
          ldap_tls_verify: document.getElementById('ldapTlsVerify').checked,
          ldap_tls_cacertfile: document.getElementById('ldapTlsCacertfile').value
        };
        const resp = await fetch('/auth/test-ldap', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        const text = await resp.text();
        modal.hide();
        alert(resp.ok ? ('LDAP测试成功\n' + text) : ('LDAP测试失败\n' + text));
      } catch (e) {
        alert('LDAP测试异常: ' + e);
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.removeEventListener('click', onConfirm);
      }
    };
    confirmBtn.addEventListener('click', onConfirm);
  });

  // 页面初始化时加载所有设置
  async function initLogin(){
    await loadLdapConfig();
    await loadPlatformConfigs(); // 先加载平台配置
    await loadAiPlatformConfig();
  }
  
  // 初始化密码切换按钮
  function initTogglePasswordButtons() {
    const toggleButtons = document.querySelectorAll('.toggle-password');
    toggleButtons.forEach(button => {
      const targetId = button.getAttribute('data-target');
      const passwordInput = document.getElementById(targetId);
      const icon = button.querySelector('i');

      if (!passwordInput || !icon) return;

      button.addEventListener('click', async () => {
        if (passwordInput.type === 'password') {
          // 显示密码/API key
          passwordInput.type = 'text';
          icon.classList.remove('bi-eye-slash');
          icon.classList.add('bi-eye');
          
          // 如果是API key输入框且当前显示的是脱敏值，则获取完整值
          if (targetId === 'platformApiKey' && passwordInput.value && passwordInput.value.endsWith('***')) {
            try {
              const currentPlatform = document.getElementById('platformSelect').value;
              const resp = await fetch('/auth/app-config/raw-secrets');
              if (resp.ok) {
                const secrets = await resp.json();
                const apiKey = secrets.platform_api_keys?.[currentPlatform];
                if (apiKey) {
                  passwordInput.value = apiKey;
                }
              }
            } catch (error) {
              console.error('Error fetching raw API key:', error);
            }
          }
        } else {
          // 隐藏密码/API key
          passwordInput.type = 'password';
          icon.classList.remove('bi-eye');
          icon.classList.add('bi-eye-slash');
          
          // 如果是API key输入框，恢复脱敏显示
          if (targetId === 'platformApiKey' && passwordInput.value && !passwordInput.value.endsWith('***')) {
            const maskedKey = passwordInput.value.substring(0, 8) + '***';
            passwordInput.value = maskedKey;
          }
        }
      });
    });
  }

  // 页面加载完成后执行初始化
  document.addEventListener('DOMContentLoaded', () => {
    initTogglePasswordButtons();
    initLogin();
  });
</script>
</body>
</html>

LDAP